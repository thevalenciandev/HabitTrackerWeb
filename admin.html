<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Habit tracker - Administration 🔑</title>
  <script type="text/javascript" src="users.js"></script>
  <script type="text/javascript" src="habits.js"></script>
  <script type="text/javascript" src="schedules.js"></script>
  <script type="text/javascript" src="html-utils.js"></script>
</head>

<body>
  <h1>Habit tracker administration 🔑</h1>
  <a href="index.html">Go home</a>

  <h2>Users</h2>
  <div id="list-user"></div>
  <div id="outcomeAction-user"></div>

  <h2>Habits</h2>
  <div id="list-habit"></div>
  <div id="outcomeAction-habit"></div>

  <h2>Schedules</h2>
  <div id="list-schedule"></div>
  <div id="outcomeAction-schedule"></div>

  <h2>Add new users</h2>
  <form action="javascript:tryAddUser()">
    <label for="luser">User name:</label>
    <input type="text" id="luser">
    <input type="submit" value="Add">
  </form>
  <div id="outcomeAdd-user"></div>

  <h2>Add new habits</h2>
  <form action="javascript:tryAddHabit()">
    <label for="lhabit">Habit:</label>
    <input type="text" id="lhabit">
    <input type="submit" value="Add">
  </form>
  <div id="outcomeAdd-habit"></div>

  <h2>Add schedules</h2>
  <form action="javascript:tryAddSchedule()">
    <select name=uschedule” id="uschedule"></select>
    <select name=hschedule” id="hschedule"></select>
    <input type="checkbox" id="mon" name="cbshedule" value="Mon">
    <label for="mon">Mon</label>
    <input type="checkbox" id="tue" name="cbshedule" value="Tue">
    <label for="tue">Tue</label>
    <input type="checkbox" id="wed" name="cbshedule" value="Wed">
    <label for="weds">Wed</label>
    <input type="checkbox" id="thu" name="cbshedule" value="Thu">
    <label for="tues">Thu</label>
    <input type="checkbox" id="fri" name="cbshedule" value="Fri">
    <label for="tues">Fri</label>
    <input type="checkbox" id="sat" name="cbshedule" value="Sat">
    <label for="tues">Sat</label>
    <input type="checkbox" id="sun" name="cbshedule" value="Sun">
    <label for="tues">Sun</label>
    <input type="submit" value="Add">
  </form>
  <div id="outcomeAdd-schedule"></div>

  <script>
    // This function relies on a naming convention to work:
    // html lists must be named list-elmType, where elmType can be eg. user, habit, etc
    // Also the messages generated by this function rely on divs named outcomeAction-elmType
    function populateList(elmType, getListElmFunction, addElmFunction, removeElmFunction) {
      const listDiv = document.getElementById("list-" + elmType)
      const list = getListElmFunction()
      if (list.length == 0) {
        listDiv.innerText = "None."
        return
      }
      // 1. First clear the div 
      while (listDiv.firstChild) {
        listDiv.firstChild.remove()
      }
      // 2. Populate current list on div
      list.forEach(e => {
        const onClickRemoveFunction = () => {
          removeElmFunction(e);
          displayOutcome("outcomeAction-" + elmType, "Sucessfully removed! 🎉");
          populateList(
            elmType,
            getListElmFunction,
            addElmFunction,
            removeElmFunction
          ); // Refresh list again
          populateScheduleDropDownLists() // TODO: pass this as a clearFunction?
        }
        listDiv.appendChild(createListElement(e, onClickRemoveFunction))
      })
    }

    function populateScheduleDropDownLists() {
      const users = getExistingUsers()
      const usersDropList = document.getElementById("uschedule")
      // 1. First clear the list 
      while (usersDropList.firstChild) {
        usersDropList.firstChild.remove()
      }
      if (users.length > 0) {
        users.forEach(u => {
          const op = document.createElement("option")
          op.setAttribute("value", u)
          op.innerText = u
          usersDropList.appendChild(op)
        })
      }
      const habitsDropList = document.getElementById("hschedule")
      // 1. First clear the list 
      while (habitsDropList.firstChild) {
        habitsDropList.firstChild.remove()
      }
      const habits = getExistingHabits()
      if (habits.length > 0) {
        habits.forEach(h => {
          const op = document.createElement("option")
          op.setAttribute("value", h)
          op.innerText = h
          habitsDropList.appendChild(op)
        })
      }
    }

    function populateSchedules() {
      const listDiv = document.getElementById("list-schedule")
      const schedules = getExistingSchedules()
      if (schedules.length == 0) {
        listDiv.innerText = "None."
        return
      }
      // 1. First clear the div 
      while (listDiv.firstChild) {
        listDiv.firstChild.remove()
      }
      
      // 2. Populate current table on div
      const schedulesTable = document.createElement("table")
      // header
      const headerRow = document.createElement("tr")
      schedulesTable.appendChild(headerRow)
      Array.from(["Who", "What", "When", "Action"])
        .forEach(e => {
          const thElm = document.createElement("th")
          thElm.innerText = e
          headerRow.appendChild(thElm)
        })
      listDiv.appendChild(schedulesTable)

      // rows
      schedules.forEach(s => {
        const onClickRemoveFunction = () => {
          removeSchedule(s);
          displayOutcome("outcomeAction-schedule", "Sucessfully removed! 🎉");
          populateSchedules(); // Refresh table again
        }
        const sched = Schedule.from(s)
        const trUsr = document.createElement("td")
        trUsr.innerText = sched.user
        const trHbt = document.createElement("td")
        trHbt.innerText = sched.habit
        const trDays = document.createElement("td")
        trDays.innerText = sched.days
        const trRemove = document.createElement("td")
        trRemove.appendChild(createRemoveBtn(onClickRemoveFunction))
        const row = document.createElement("tr")
        row.appendChild(trUsr)
        row.appendChild(trHbt)
        row.appendChild(trDays)
        row.appendChild(trRemove)
        schedulesTable.appendChild(row)
      })
    }

    function tryAddUser() {
      const newUser = document.getElementById("luser").value
      if (getExistingUsers().includes(newUser)) {
        alert(`${newUser} already exists`)
        return
      }
      addUser(newUser)
      displayOutcome("outcomeAdd-user", "Sucessfully added! 🎉")
      populateList("user", () => getExistingUsers(), u => addUser(u), u => removeUser(u))
      populateScheduleDropDownLists()
    }

    function tryAddHabit() {
      const newHabit = document.getElementById("lhabit").value
      if (getExistingHabits().includes(newHabit)) {
        alert(`${newHabit} already exists`)
        return
      }
      addHabit(newHabit)
      displayOutcome("outcomeAdd-habit", "Sucessfully added! 🎉")
      populateList("habit", () => getExistingHabits(), h => addHabit(h), h => removeHabit(h))
      populateScheduleDropDownLists()
    }

    function tryAddSchedule() {
      const checkboxes = Array.from(document.querySelectorAll('input[name="cbshedule"]:checked'));
      const selectedDays = checkboxes.filter(cb => cb.checked).map(cb => cb.value).join(",")

      const usrDl = document.getElementById("uschedule")
      const selectedUsr = usrDl.options[usrDl.selectedIndex].value

      const hbtDl = document.getElementById("hschedule")
      const selectedHbt = hbtDl.options[hbtDl.selectedIndex].value

      //TODO: this splitting shouldn't be done here, it's a storage concern. Abstract away.
      const newSchedule = `${selectedUsr}|${selectedHbt}|${selectedDays}`
      if (getExistingSchedules().includes(newSchedule)) {
        alert(`${newSchedule} already exists`)
        return
      }
      addSchedule(newSchedule)
      displayOutcome("outcomeAdd-schedule", "Sucessfully added! 🎉")
      populateSchedules()
    }

    // Upon loading page, do the following:
    populateList("user", () => getExistingUsers(), u => addUser(u), u => removeUser(u))
    populateList("habit", () => getExistingHabits(), h => addHabit(h), h => removeHabit(h))
    populateScheduleDropDownLists()
    populateSchedules()
  </script>
</body>

</html>